env:
  global:
    - DOCKER_BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH}
    - DOCKER_BRANCH=${DOCKER_BRANCH//[\@\/]/-}
    - TESTS_TYPE=${TESTS_TYPE}
    - TEST_TAG=${TEST_TAG}
    - BRANCH_WITH_FULL_TESTS=master
language: node_js
node_js:
  - '10'
services:
  - docker
before_install:
  - npm install -g npm@latest
install:
  - npm install
  #  - npm run prepare
  - npm run prod
jobs:
  include:
    - stage: 'Docker build'
      script:
        - docker pull "securetrading1/js-payments-card"
        - docker build . --tag "securetrading1/js-payments-card:$DOCKER_BRANCH"
        - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
        - docker push "securetrading1/js-payments-card"
        - cd js-payments-testing
        - git pull --ff-only origin master
        - docker build . --build-arg "CODE_VERSION=$DOCKER_BRANCH" --tag "securetrading1/js-payments-testing:$DOCKER_BRANCH"
        - docker push "securetrading1/js-payments-testing"
    - stage: 'Test'
      name: 'Unit tests'
      script:
        - npm run coverage
        - npm run snyk
    - name: "Behavioural test: chrome 76, Windows 10"
      if: env(TESTS_TYPE)=fullTest OR env(TESTS_TYPE)=smokeTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos=Windows -Dos_version=10 -Dbrowser=chrome -Dbrowser_version=76.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: chrome 75, Windows 8.1"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos=Windows -Dos_version=8.1 -Dbrowser=chrome -Dbrowser_version=75.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: chrome 76, Windows 8"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos=Windows -Dos_version=8 -Dbrowser=chrome -Dbrowser_version=76.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: chrome 76, OS X Mojave"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos="OS X" -Dos_version=Mojave -Dbrowser=chrome -Dbrowser_version=76.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: chrome 75, OS X High Sierra"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos="OS X" -Dos_version="High Sierra" -Dbrowser=chrome -Dbrowser_version=75.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: chrome 76, OS X Sierra"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos="OS X" -Dos_version=Sierra -Dbrowser=chrome -Dbrowser_version=76.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: firefox 68, Windows 10"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos=Windows -Dos_version=10 -Dbrowser=Firefox -Dbrowser_version=68.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: firefox 67, Windows 8.1"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos=Windows -Dos_version=8.1 -Dbrowser=Firefox -Dbrowser_version=67.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: firefox 68, Windows 7"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos=Windows -Dos_version=7 -Dbrowser=Firefox -Dbrowser_version=68.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: firefox 68, OS X Mojave"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos="OS X" -Dos_version=Mojave -Dbrowser=Firefox -Dbrowser_version=68.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: firefox 67, OS X High Sierra"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos="OS X" -Dos_version="High Sierra" -Dbrowser=Firefox -Dbrowser_version=67.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: firefox 68, OS X Sierra"
      if: branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave - mvn install -DLOCAL=true -Dos="OS X" -Dos_version=Sierra -Dbrowser=Firefox -Dbrowser_version=68.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: ie 11, Windows 10"
      if: env(TESTS_TYPE)=fullTest OR env(TESTS_TYPE)=smokeTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos=Windows -Dos_version=10 -Dbrowser=IE -Dbrowser_version=11.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: ie 10, Windows 8"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos=Windows -Dos_version=8 -Dbrowser=IE -Dbrowser_version=10.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: edge 18, Windows 10"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos=Windows -Dos_version=10 -Dbrowser=Edge -Dbrowser_version=18.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: edge 17, Windows 10"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos=Windows -Dos_version=10 -Dbrowser=Edge -Dbrowser_version=17.0 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: safari 12.1, OS X Mojave"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos="OS X" -Dos_version=Mojave -Dbrowser=Safari -Dbrowser_version=12.1 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: safari 11.1, OS X High Sierra"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos="OS X" -Dos_version="High Sierra" -Dbrowser=Safari -Dbrowser_version=11.1 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: safari 10.1, OS X Sierra"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Dos="OS X" -Dos_version=Sierra -Dbrowser=Safari -Dbrowser_version=10.1 -Dresolution=1920x1080 -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Samsung Galaxy Note 9, Android 8.1"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Samsung Galaxy Note 9" -Dos_version=8.1 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Samsung Galaxy S9, Android 8.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Samsung Galaxy S9" -Dos_version=8.0 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Samsung Galaxy S9 Plus, Android 9.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Samsung Galaxy S9 Plus" -Dos_version=9.0 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Samsung Galaxy S8, Android 7.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Samsung Galaxy S8" -Dos_version=7.0 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Samsung Galaxy S7, Android 6.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Samsung Galaxy S7" -Dos_version=6.0 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Samsung Galaxy Tab S3, Android 7.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Samsung Galaxy Tab S3" -Dos_version=7.0 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Google Pixel 3, Android 9.0"
      if: env(TESTS_TYPE)=fullTestv
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Google Pixel 3" -Dos_version=9.0 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Google Pixel, Android 8.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Google Pixel" -Dos_version=8.0 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Google Pixel, Android 7.1"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Google Pixel" -Dos_version=7.1 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Google Nexus 6, Android 6.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Google Nexus 6" -Dos_version=6.0 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Google Nexus 9, Android 5.1"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Google Nexus 9" -Dos_version=5.1 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: Google Nexus 5, Android 4.4"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="Google Nexus 5" -Dos_version=4.4 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: iPhone XS, iOS 12.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="iPhone XS" -Dos_version=12 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: iPhone XS Max, iOS 12.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="iPhone XS Max" -Dos_version=12 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: iPhone XR, iOS 12.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="iPhone XR" -Dos_version=12 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: iPhone X, iOS 11.0"
      if: env(TESTS_TYPE)=fullTest OR env(TESTS_TYPE)=smokeTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="iPhone X" -Dos_version=11 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: iPhone 8, iOS 11.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="iPhone 8" -Dos_version=11 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: iPhone SE, iOS 11.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="iPhone SE" -Dos_version=11 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: iPad Pro 12.9 2018, iOS 12.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="iPad Pro 12.9 2018" -Dos_version=12 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
    - name: "Behavioural test: iPad Mini 4, iOS 11.0"
      if: env(TESTS_TYPE)=fullTest OR branch = env(BRANCH_WITH_FULL_TESTS)
      script:
        - npm run behave -- mvn install -DLOCAL=true -Ddevice="iPad Mini 4" -Dos_version=11 -Dreal_mobile=true -Dcucumber.options="--tags $TEST_TAG"
after_success:
  - cat ./coverage/lcov.info | coveralls
addons:
  browserstack:
    forcelocal: true
    username:
      secure: IGb/0IXCn3UruY1THXDInzbVSTcTmWAySwH50XkvuhEzhBNZaxtRFzpW1vxNXSOZj06SY0B8aO9p4jL3kYIcvtiA4x4lyP3yW6lX8IlkZ+ICNNmvTRSvlUcQRc7SPqSXtdCHB0I85SmNkBN/hArz9h0a26ohrAOertEnDYPu0UbNg9nRZEOb3oLo4V1q21ikAOi3G6dVZFF55kc3D94eGtiPTl1fJiqbmZ39DB1mZTx1ccxqej44kiRWPCTHWZIdB52mWJLfYaCfTa0ZCRTsxGKx4MbnWn6/9OAgeUNwdI+Ls6B9GS/MfPx8yDi3R18f+zyp3xYLYSKT6/fkjIiqoJOf4Sv7SZ7ZQ0xw1CPjAmlHTql4WIAlLzJkaFfZ6Ype57PR53o0yAA+9t0yL7Msjqu+agm/3Wxnuo9PMjK4oHYq6yxmF3wTEN38m18iECznPiHRKFgWHNByGvdpLC4+cPit0r49pqMgRoqlcUDwQ9X57eQYxiBWS/aupDljrhuqI9SQLHyXaEF6L39XbtCrAB03iKmBXCppAJaBXxxmccR7gexkVuRD0Oqujvt1VrwIPVzmsC9YnrI5mBmwhoUWMNDmsyKtO5J0iszxWlW7UMP4v7EjMb8Ox/QjjfSbuZMI3MFhZevP1HkrnlZQVeKpfNY0brSj7PjYsC4vGdEnmyM=
    access_key:
      secure: 2vd2XXapzTBDNntCYO7Ngw4DGsyoLfaBURPkZ5Avw65jt9QBz5WM9A2lSZA8lyONDmAx28TAE2rasfX/3E82rE1Giq9GOgKtI0WoDgCfOUxT9gQ8XUwUbwv2U84M17tiXsCJ31xpKY+avEMGfAcl7MtJCL1JyGXHe3uI7H7C0zKwapmAZzYZy/0wJFu1YVpb3TD4w1B0VUWuTG9etVrwOIzlfBKwyvASGGT1zaI6bav/qzxPLkJuWzllV2KcHEY8d4DzrWwZQuofKKFgN4gGTQoQPeuNq6zGG+J/kXdxfAYKquTKMwa7ofwAPBzxbAaV5IBCSEvC/OeNxUBohvauRDIYoq61cz7C8iWycBeOfdz/ofSmUIMQiJbaWJJp6ZDGF/DmK0sGrq8Q8PqD8fAxVI3ApZBPHidV22OE3YtcnQ4DslT/4LXcqaFhHEhK8SAVzW0PVUcuD7mlekUVKpDk6PP2bjRWucMgNykjTSj6cUhQIjD9GIaWCg+qz80nKN1KBT+9d4ejCOoPa0fVtJjvXtN9svfK56KxYZT9sfyl533JpO3+0uozeBYNBripnceWVIJCPCSPgqeISZtxPMIoLID55mPqLSIjdPP/9a8uS7zL0nfVF0I781Lerskh0cG9zCRE0NvB30m25qz/8lvpwCUHco0z3vZ7yOdvwgTn7wA=
    hosts:
      - webservices.securetrading.net
      - merchant.example.com
      - thirdparty.example.com
